version: '3'
services:
  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_USER=application
      - MYSQL_PASSWORD=application
      - MYSQL_DATABASE=loopers
      - MYSQL_CHARACTER_SET=utf8mb4
      - MYSQL_COLLATE=utf8mb4_general_ci
    volumes:
      - mysql-8-data:/var/lib/mysql
    # 부하테스트를 위한 성능 저하 설정
    deploy:
      resources:
        limits:
          cpus: '0.05'  # CPU 사용량을 5%로 제한
          memory: 256M  # 메모리를 256MB로 제한
        reservations:
          cpus: '0.05'  # 최소 CPU 보장
          memory: 192M  # 최소 메모리 보장
    # MySQL 버퍼 풀 크기 제한 (인덱스 없을 때 풀 테이블 스캔으로 인한 디스크 I/O 증가 효과)
    command: 
      - --innodb-buffer-pool-size=96M  # 버퍼 풀을 96MB로 제한 (전체 메모리 고려)
      - --innodb-log-file-size=16M  # 로그 파일 크기 제한 (메모리 절약)
      - --max-connections=30  # 최대 연결 수 제한 (메모리 절약)
      - --table-open-cache=200  # 테이블 캐시 크기 제한
      - --thread-cache-size=8  # 스레드 캐시 크기 제한

  redis-master:
    image: redis:7.0
    container_name: redis-master
    ports:
      - "6379:6379"
    volumes:
      - redis_master_data:/data
    # 부하테스트를 위한 성능 저하 설정
    deploy:
      resources:
        limits:
          cpus: '0.01'  # CPU 사용량을 1%로 제한 (매우 느린 처리)
          memory: 64M  # 메모리를 64MB로 제한 (최소 요구사항)
        reservations:
          cpus: '0.01'  # 최소 CPU 보장
          memory: 48M  # 최소 메모리 보장
    command:
      [
        "redis-server", # redis 서버 실행 명령어
        "--appendonly", "yes", # AOF (AppendOnlyFile) 영속성 기능 켜기
        "--save", "",
        "--latency-monitor-threshold", "100", # 특정 command 가 지정 시간(ms) 이상 걸리면 monitor 기록
        "--maxmemory", "2gb", # 최대 메모리 2GB (시스템 메모리에 따라 조정 필요)
        # "--maxmemory", "5mb", # eviction 테스트용
        "--maxmemory-policy", "volatile-lru", # TTL이 있는 키 중 최근 사용 안 된 키 삭제
        # Eviction Policy 옵션:
        # - volatile-lru: TTL이 있는 키 중 LRU로 삭제
        # - allkeys-lru: 모든 키 중 LRU로 삭제
        # - volatile-lfu: TTL이 있는 키 중 LFU로 삭제
        # - allkeys-lfu: 모든 키 중 LFU로 삭제
        # - volatile-random: TTL이 있는 키 중 랜덤 삭제
        # - allkeys-random: 모든 키 중 랜덤 삭제
        # - volatile-ttl: TTL이 있는 키 중 만료 시간이 짧은 것부터 삭제
        # - noeviction: 메모리 초과 시 에러 반환 (삭제 안 함)
      ]
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6379", "PING"]
      interval: 5s
      timeout: 2s
      retries: 10

  redis-readonly:
    image: redis:7.0
    container_name: redis-readonly
    depends_on:
      redis-master:
        condition: service_healthy
    ports:
      - "6380:6379"
    volumes:
      - redis_readonly_data:/data
    # 부하테스트를 위한 성능 저하 설정
    deploy:
      resources:
        limits:
          cpus: '0.01'  # CPU 사용량을 1%로 제한 (매우 느린 처리)
          memory: 64M  # 메모리를 64MB로 제한 (최소 요구사항)
        reservations:
          cpus: '0.01'  # 최소 CPU 보장
          memory: 48M  # 최소 메모리 보장
    command:
      [
        "redis-server",
        "--appendonly", "yes",
        "--appendfsync", "everysec",
        "--replicaof", "redis-master", "6379", # replica 모드로 실행 + 서비스 명, 서비스 포트
        "--replica-read-only", "yes", # 읽기 전용으로 설정
        "--latency-monitor-threshold", "10", # 지연 모니터링 임계값 낮춤 (10ms)
        "--maxmemory", "48mb", # 최대 메모리 48MB로 제한 (eviction 빈번하게 발생)
        "--maxmemory-policy", "allkeys-lru", # 모든 키 중 LRU로 삭제 (eviction 빈번)
        "--slowlog-log-slower-than", "1000", # 1ms 이상 걸리는 명령어 로깅
        "--hz", "1", # 백그라운드 작업 빈도 최소화 (성능 저하)
      ]
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6379", "PING"]
      interval: 5s
      timeout: 2s
      retries: 10

  kafka:
    image: bitnamilegacy/kafka:3.5.1
    container_name: kafka
    ports:
      - "9092:9092" # 카프카 브로커 PORT
      - "19092:19092" # 호스트 리스너 얘 떄문인가
    environment:
      - KAFKA_CFG_NODE_ID=1 # 브로커 고유 ID
      - KAFKA_CFG_PROCESS_ROLES=broker,controller # KRaft 모드여서, broker / controller 역할 모두 부여
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,PLAINTEXT_HOST://:19092,CONTROLLER://:9093
      # 브로커 클라이언트 (PLAINTEXT), 브로커 호스트 (PLAINTEXT) 내부 컨트롤러 (CONTROLLER)
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:19092
      # 외부 클라이언트 접속 호스트 (localhost:9092), 브로커 접속 호스트 (localhost:19092)
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,CONTROLLER:PLAINTEXT
      # 각 리스너별 보안 프로토콜 설정
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER # 컨트롤러 담당 리스너 지정
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093 # 컨트롤러 후보 노드 정의 (단일 브로커라 자기 자신만 있음)
      - KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=1 # consumer offset 복제 갯수 (현재는 1 - 로컬용이라서)
      - KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1 # transaction log 토픽 복제 갯수 (현재는 1 - 로컬용이라서)
      - KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR=1 # In-Sync-Replica 최소 수 (현재는 1 - 로컬용이라서)
    volumes:
      - kafka-data:/bitnami/kafka
    healthcheck:
      test: ["CMD", "bash", "-c", "kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "9099:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local  # kafka-ui 에서 보이는 클러스터명
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092 # kafka-ui 가 연겷할 브로커 주소

volumes:
  mysql-8-data:
  redis_master_data:
  redis_readonly_data:
  kafka-data:

networks:
  default:
    driver: bridge