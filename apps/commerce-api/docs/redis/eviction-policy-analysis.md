# Redis Eviction 정책 분석 및 권장사항

## 현재 상황

### 설정 상태
- **Eviction 정책**: 명시적으로 설정되지 않음 (기본값: `noeviction`)
- **Maxmemory**: 설정되지 않음 (기본값: 무제한)
- **캐시 사용 패턴**:
  - 상품 목록: 첫 페이지만 캐시, TTL 5분
  - 상품 상세: 모든 상품, TTL 5분
  - 모든 캐시 키에 TTL 설정됨

### 문제점
1. **`noeviction` 정책의 문제**:
   - 메모리 부족 시 에러 반환 (OOM 에러)
   - 캐시 용도에는 부적합
   - 메모리 제한이 없어 시스템 리소스 고갈 가능

## Eviction 정책 비교

### 1. `noeviction` (현재 기본값)
- **동작**: 메모리 부족 시 에러 반환, 키 삭제 안 함
- **장점**: 데이터 손실 없음
- **단점**: 
  - 캐시 용도에 부적합
  - 메모리 부족 시 서비스 중단
- **적합성**: ❌ 캐시 용도에는 부적합

### 2. `volatile-lru` ⭐ **권장**
- **동작**: TTL이 설정된 키 중 최근 사용 안 된 키 삭제
- **장점**:
  - TTL이 있는 캐시 키만 삭제 (안전)
  - 최근 사용 패턴 기반으로 효율적 삭제
  - 영구 데이터 보호
- **단점**: TTL이 없는 키는 삭제 안 됨 (하지만 우리는 모든 키에 TTL 설정)
- **적합성**: ✅ **가장 적합** (TTL이 설정된 캐시에 최적)

### 3. `allkeys-lru`
- **동작**: 모든 키 중 최근 사용 안 된 키 삭제
- **장점**: 
  - 더 유연한 메모리 관리
  - TTL이 있어도 삭제 가능
- **단점**: 
  - TTL이 없는 영구 데이터도 삭제될 수 있음
  - 캐시와 영구 데이터를 구분하지 못함
- **적합성**: ⚠️ 가능하지만 volatile-lru가 더 안전

### 4. `volatile-ttl`
- **동작**: TTL이 설정된 키 중 TTL이 짧은 것부터 삭제
- **장점**: 곧 만료될 키를 먼저 삭제
- **단점**: 사용 빈도를 고려하지 않음
- **적합성**: ⚠️ volatile-lru보다 덜 효율적

### 5. `volatile-lfu` / `allkeys-lfu`
- **동작**: 사용 빈도가 낮은 키 삭제
- **장점**: 사용 빈도 기반으로 효율적
- **단점**: 
  - LRU보다 복잡도 높음
  - 메모리 오버헤드 약간 더 큼
- **적합성**: ⚠️ LRU로도 충분

## 권장 설정

### Eviction 정책: `volatile-lru`
- **이유**:
  1. 모든 캐시 키에 TTL이 설정되어 있음
  2. 캐시 특성상 최근 사용 안 된 키를 삭제하는 것이 효율적
  3. TTL이 없는 영구 데이터는 보호됨
  4. 캐시 용도에 최적화

### Maxmemory 설정
- **권장**: 시스템 메모리의 50-70%
- **예시**: 
  - 4GB 시스템 → 2-3GB
  - 8GB 시스템 → 4-6GB
- **설정 방법**: `--maxmemory 2gb` 또는 `maxmemory 2gb`

## 예상 효과

### 메모리 사용량
- **현재**: 무제한 (위험)
- **변경 후**: 제한된 메모리 내에서 자동 관리

### 캐시 효율성
- **volatile-lru**: 최근 사용 안 된 캐시를 자동으로 삭제하여 메모리 효율적
- **TTL과 조합**: TTL 만료 + LRU eviction으로 이중 보호

### 안정성
- **메모리 부족 방지**: 자동으로 오래된 캐시 삭제
- **서비스 중단 방지**: OOM 에러 방지

## 구현

Docker Compose 설정에 추가:
```yaml
command:
  [
    "redis-server",
    "--appendonly", "yes",
    "--save", "",
    "--latency-monitor-threshold", "100",
    "--maxmemory", "2gb",  # 메모리 제한 설정
    "--maxmemory-policy", "volatile-lru",  # Eviction 정책
  ]
```

