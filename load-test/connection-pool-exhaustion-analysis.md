# Connection Pool 고갈 원인 분석

## 현재 설정

### DB Connection Pool
- **HikariCP**: `maximum-pool-size: 40`, `minimum-idle: 30`
- **MySQL**: `max-connections: 40`
- **Connection Timeout**: 3초

### 부하 테스트 결과
- **평균 응답 시간**: 18초 (매우 느림)
- **실패율**: 30%
- **Requests/s**: 153.69
- **DB 연결 풀 고갈 메시지**: `Connection is not available, request timed out after 3000ms (total=40, active=40, idle=0, waiting=165)`

## 원인 분석

### 결론: **두 가지 원인이 모두 작용하고 있지만, 캐시/인덱스 문제가 더 근본적인 원인입니다.**

## 1. Connection Pool 크기 문제 (부차적 원인)

### 현재 상황
- **HikariCP**: 40개 연결
- **MySQL**: 40개 연결 허용
- **대기 중인 요청**: 165개

### 문제점
1. **연결 풀 크기 부족**
   - 동시 요청이 200개 이상인데 연결 풀은 40개만 제공
   - 165개 요청이 연결을 기다리는 중

2. **연결 점유 시간이 너무 김**
   - 평균 응답 시간: 18초
   - 연결 하나당 18초 동안 점유
   - 40개 연결로는 초당 약 2.2개 요청만 처리 가능 (40 / 18)
   - 실제 요청: 초당 153.69개 → **약 70배 부족**

### 계산
```
필요한 연결 수 = (평균 응답 시간 × 초당 요청 수)
                = 18초 × 153.69 req/s
                = 약 2,766개 연결 필요
```

**하지만 이는 비현실적입니다.** 연결 풀을 늘리는 것만으로는 해결되지 않습니다.

## 2. 캐시/인덱스 문제 (근본 원인)

### 현재 캐시 전략
- **상품 목록**: 첫 페이지만 캐시 (page=0)
- **상품 상세**: 모든 상품 캐시 (하지만 각기 다른 ID로 1회씩만 조회)

### 문제점

#### 2.1 캐시 히트율이 매우 낮음
- **상품 목록**: 
  - 첫 페이지만 캐시 → 약 20-30% 히트율
  - 두 번째 페이지 이상은 모두 DB 조회 → 70-80%가 DB 조회
- **상품 상세**:
  - 각기 다른 ID로 1회씩만 조회 → 캐시 효과 거의 없음
  - 대부분 DB 조회

#### 2.2 DB 쿼리 실행 시간이 너무 김
- **평균 응답 시간: 18초**
- 이는 다음을 의미:
  - 인덱스가 제대로 활용되지 않거나
  - 쿼리가 비효율적이거나
  - MySQL 리소스가 부족하거나
  - 캐시 미스로 인한 DB 부하 과다

### 실제 DB 부하 계산
```
초당 DB 쿼리 수 = 초당 요청 수 × (1 - 캐시 히트율)
                = 153.69 × (1 - 0.2)  # 캐시 히트율 20% 가정
                = 약 123개 쿼리/초

연결당 처리 시간 = 18초
필요한 연결 수 = 123 × 18 = 2,214개
```

**40개 연결로는 절대 처리 불가능합니다.**

## 3. 근본 원인: 응답 시간이 너무 김

### 왜 응답 시간이 18초인가?

1. **캐시 미스 → DB 조회**
2. **DB 쿼리 실행 시간이 김**
   - 인덱스 미활용 가능성
   - MySQL 리소스 제한 (CPU 5%, 메모리 256MB)
   - 버퍼 풀 크기 제한 (96MB)
3. **연결 대기 시간**
   - 연결 풀 고갈로 대기 시간 증가
   - 대기 중인 요청이 165개

### 악순환
```
캐시 미스 증가 
  → DB 쿼리 증가 
    → 연결 점유 시간 증가 (18초)
      → 연결 풀 고갈
        → 대기 시간 증가
          → 전체 응답 시간 증가
            → 더 많은 연결 필요
              → 연결 풀 고갈 악화
```

## 해결 전략 우선순위

### 1순위: 캐시 전략 개선 (가장 효과적)

**예상 효과:**
- 캐시 히트율: 20% → 80%
- DB 쿼리 감소: 80% → 20%
- 연결 필요 수: 2,214개 → 553개 (여전히 많지만 4배 감소)

**구현:**
- 상품 목록: 상위 5페이지까지 캐시
- 캐시 TTL: 5분 → 10분

### 2순위: 응답 시간 개선 (인덱스/쿼리 최적화)

**목표:**
- 평균 응답 시간: 18초 → 1-2초
- 연결 점유 시간: 18초 → 2초
- 필요한 연결 수: 2,214개 → 246개 (9배 감소)

**구현:**
- 인덱스 사용 확인 및 최적화
- 쿼리 실행 계획 분석
- MySQL 리소스 증가 (선택적)

### 3순위: Connection Pool 크기 조정

**캐시/인덱스 개선 후:**
- 필요한 연결 수: 약 50-100개
- 현재: 40개 → **50-100개로 증가**

**주의:**
- 연결 풀만 늘리는 것은 임시방편
- 근본 원인(응답 시간) 해결이 우선

## 결론

### Connection Pool 고갈의 근본 원인

1. **캐시 히트율이 낮아 DB 쿼리가 과다** (70-80%가 DB 조회)
2. **응답 시간이 너무 김** (18초) → 연결 점유 시간 증가
3. **연결 풀 크기가 부족** (40개로는 부족)

### 해결 순서

1. **캐시 전략 개선** (우선순위: 최고)
   - 상위 5페이지까지 캐시
   - 캐시 히트율 80% 목표
   - 예상 효과: DB 쿼리 80% 감소

2. **응답 시간 개선** (우선순위: 높음)
   - 인덱스 최적화
   - 쿼리 실행 계획 분석
   - 예상 효과: 응답 시간 18초 → 1-2초

3. **Connection Pool 크기 조정** (우선순위: 중간)
   - 캐시/인덱스 개선 후 필요 시 조정
   - 40개 → 50-100개
   - 예상 효과: 대기 시간 감소

### 예상 개선 효과

**캐시 + 인덱스 개선 후:**
- 캐시 히트율: 20% → 80%
- 평균 응답 시간: 18초 → 1-2초
- 필요한 연결 수: 2,214개 → 약 50개
- 연결 풀 크기: 40개 → 50-100개 (충분)

**결론: Connection Pool 크기 문제보다는 캐시/인덱스 최적화가 더 중요합니다.**

## 참고: 연결 풀 크기 계산 공식

```
필요한 연결 수 = (평균 응답 시간 × 초당 DB 쿼리 수) / (1 - 캐시 히트율)

현재:
= (18초 × 153.69 req/s) / (1 - 0.2)
= 2,766 / 0.8
= 약 3,458개 (비현실적)

개선 후 (캐시 히트율 80%, 응답 시간 2초):
= (2초 × 30.74 req/s) / (1 - 0.8)  # 153.69 × 0.2 = 30.74
= 61.48 / 0.2
= 약 308개

더 개선 (응답 시간 1초):
= (1초 × 30.74 req/s) / 0.2
= 약 154개

최종 목표 (응답 시간 0.5초):
= (0.5초 × 30.74 req/s) / 0.2
= 약 77개
```

**50-100개 연결 풀로 충분합니다.**

